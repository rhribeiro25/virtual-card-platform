# -----------------------------------------------
# üîÅ CD - Promote Docker Image Between Heroku Environments
# -----------------------------------------------
name: CD - Promote Heroku Release by Tag

on:
  workflow_dispatch:
    inputs:
      from_tag:
        description: 'Tag name to promote from (e.g. v1.0.0-dev)'
        required: true
      to_env:
        description: 'Target environment (hml or prd)'
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: üß† Parse inputs
        id: parse
        run: |
          echo "FROM_TAG=${{ github.event.inputs.from_tag }}" >> $GITHUB_ENV
          echo "TO_ENV=${{ github.event.inputs.to_env }}" >> $GITHUB_ENV

          ENV_SUFFIX="${{ github.event.inputs.from_tag##*- }}"
          echo "SOURCE_ENV=$ENV_SUFFIX" >> $GITHUB_ENV

          if [[ "$ENV_SUFFIX" =~ ^(dev|hml|prd)$ ]]; then
            echo "SOURCE_APP=virtual-card-platform-$ENV_SUFFIX" >> $GITHUB_ENV
          else
            echo "‚ùå Invalid source tag format"; exit 1
          fi

          if [[ "${{ github.event.inputs.to_env }}" =~ ^(hml|prd)$ ]]; then
            echo "TARGET_APP=virtual-card-platform-${{ github.event.inputs.to_env }}" >> $GITHUB_ENV
          else
            echo "‚ùå Invalid target environment"; exit 1
          fi

      - name: ‚òÅÔ∏è Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          heroku --version

      - name: üîê Login to Heroku Container Registry
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: heroku container:login

      - name: ‚è© Promote Docker image
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
        run: |
          echo "Promoting Docker image from $SOURCE_APP to $TARGET_APP"

          docker pull registry.heroku.com/$SOURCE_APP/web
          docker tag registry.heroku.com/$SOURCE_APP/web registry.heroku.com/$TARGET_APP/web
          docker push registry.heroku.com/$TARGET_APP/web
          heroku container:release web --app $TARGET_APP

          echo "‚úÖ Promotion complete from $SOURCE_APP to $TARGET_APP"
